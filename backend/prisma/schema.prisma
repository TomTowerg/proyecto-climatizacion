// ============================================
// SCHEMA CORREGIDO - MÚLTIPLES EQUIPOS POR COTIZACIÓN
// Reemplazar: backend/prisma/schema.prisma
// ============================================

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  username      String?
  password      String?
  googleId      String?  @unique
  name          String?
  role          String   @default("user")
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Cliente {
  id              Int           @id @default(autoincrement())
  
  // Datos públicos (sin cifrar - necesarios para búsquedas)
  nombre          String
  
  // ============================================
  // DATOS CIFRADOS - NUEVO
  // ============================================
  rut_encrypted      String?
  rut_hash           String?  @unique  // Para búsquedas sin descifrar
  email_encrypted    String?
  email_hash         String?  @unique  // Para búsquedas sin descifrar
  telefono_encrypted String?
  direccion_encrypted String?
  
  // ============================================
  // CAMPOS ANTIGUOS - MANTENER POR AHORA
  // (Eliminar después de migración exitosa)
  // ============================================
  rut             String?  @unique  // DEPRECATED - usar rut_encrypted
  email           String?           // DEPRECATED - usar email_encrypted
  telefono        String?           // DEPRECATED - usar telefono_encrypted
  direccion       String?           // DEPRECATED - usar direccion_encrypted
  
  // Fechas
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relaciones
  equipos         Equipo[]
  ordenesTrabajos OrdenTrabajo[]
  cotizaciones    Cotizacion[]
}

model Inventario {
  id                      Int      @id @default(autoincrement())
  tipo                    String
  marca                   String
  modelo                  String
  capacidad               String?  // Opcional para compatibilidad
  capacidadBTU            String?  // Mantener compatibilidad
  numeroSerie             String?  // Mantener compatibilidad
  codigoModelo            String?  // Mantener compatibilidad
  caracteristicas         String?  // Mantener compatibilidad
  metrosCuadrados         String?
  tipoGas                 String
  precioNeto              Float
  precioConIVA            Float
  precioMaterial          Float
  valorLogistica          Float
  valorMaterial           Float
  precioCliente           Float
  precioClienteNeto       Float
  precioClienteIVA        Float
  valorEquipoMaterialIVA  Float
  gananciaDescontandoIVA  Float
  gananciaDescontandoTecnicos Float
  stock                   Int      @default(0)
  estado                  String   @default("disponible")
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  cotizaciones            Cotizacion[]
  equiposCotizacion EquipoCotizacion[]
  equipos                 Equipo[]
}

model Cotizacion {
  id              Int         @id @default(autoincrement())
  clienteId       Int
  cliente         Cliente     @relation(fields: [clienteId], references: [id])
  inventarioId    Int?
  inventario      Inventario?  @relation(fields: [inventarioId], references: [id])
  equipoId        Int?
  equipo          Equipo?     @relation(fields: [equipoId], references: [id])
  tipo            String?     // Opcional para compatibilidad
  marca           String?     // Opcional para compatibilidad
  modelo          String?     // Opcional para compatibilidad
  capacidad       String?     // Opcional para compatibilidad
  precioOfertado  Float
  costoInstalacion Float      @default(100000)
  costoMaterial   Float       @default(0)
  subtotal        Float
  descuento       Float       @default(0)
  precioFinal     Float
  estado          String      @default("pendiente")
  fechaCotizacion DateTime    @default(now())
  fechaRespuesta  DateTime?
  fechaAprobacion DateTime?
  notas           String?
  agente          String?
  direccionInstalacion String?
  equiposCreados  Equipo[]    @relation("EquiposDeCotizacion")
  ordenCreada     OrdenTrabajo? @relation("CotizacionAprobada")
  equipos       EquipoCotizacion[]
  materiales      MaterialCotizacion[]
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}


model Equipo {
  id                Int      @id @default(autoincrement())
  tipo              String
  marca             String
  modelo            String
  numeroSerie       String   @unique
  capacidad         String
  tipoGas           String
  ano               Int?
  fechaCompra       DateTime?  // Mantener compatibilidad
  fechaInstalacion  DateTime?  // Mantener compatibilidad
  clienteId         Int
  cliente           Cliente  @relation(fields: [clienteId], references: [id])
  inventarioId      Int?
  inventario        Inventario? @relation(fields: [inventarioId], references: [id])
  cotizacionId      Int?
  cotizacion        Cotizacion? @relation("EquiposDeCotizacion", fields: [cotizacionId], references: [id])
  
  estado            String   @default("activo")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  ordenesTrabajos   OrdenTrabajo[]
  cotizacionesMantenimiento Cotizacion[]
}

model OrdenTrabajo {
  id            Int      @id @default(autoincrement())
  clienteId     Int
  cliente       Cliente  @relation(fields: [clienteId], references: [id])
  equipoId      Int?
  equipo        Equipo?  @relation(fields: [equipoId], references: [id])
  cotizacionId  Int?     @unique
  cotizacion    Cotizacion? @relation("CotizacionAprobada", fields: [cotizacionId], references: [id])
  tipo          String
  descripcion   String?  // Opcional para compatibilidad
  fecha         DateTime?  // Mantener compatibilidad
  tecnico       String?    // Mantener compatibilidad
  urgencia      String?    // Mantener compatibilidad
  estado        String   @default("pendiente")
  prioridad     String   @default("media")
  fechaInicio   DateTime?
  fechaFin      DateTime?
  trabajoRealizado String?
  materialesUsados String?
  costoMateriales  Float?
  costoManoObra    Float?
  costoTotal       Float?
  notas         String?
  analisisIA    String?
  calificacion  Int?
  comentarioCliente String?
  fechaCompletado DateTime?
  documentoFirmado String?
  fechaFirma       DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Tabla para múltiples equipos en cotizaciones
model EquipoCotizacion {
  id            Int      @id @default(autoincrement())
  cotizacionId  Int
  cotizacion    Cotizacion @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  inventarioId  Int
  inventario    Inventario @relation(fields: [inventarioId], references: [id])
  cantidad      Int
  precioUnitario Float
  subtotal      Float
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([cotizacionId])
  @@index([inventarioId])
}

model MaterialCotizacion {
  id              Int        @id @default(autoincrement())
  cotizacionId    Int
  cotizacion      Cotizacion @relation(fields: [cotizacionId], references: [id], onDelete: Cascade)
  materialInventarioId Int?
  materialInventario   MaterialInventario? @relation(fields: [materialInventarioId], references: [id])
  nombre          String
  cantidad        Float
  unidad          String
  precioUnitario  Float
  subtotal        Float
  descripcion     String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([cotizacionId])
  @@index([materialInventarioId])
}

// ⭐ NUEVO: Inventario de Materiales
model MaterialInventario {
  id              Int      @id @default(autoincrement())
  nombre          String
  categoria       String
  unidad          String
  precioNeto      Float
  precioConIVA    Float
  stock           Int      @default(0)
  stockMinimo     Int      @default(5)
  proveedor       String?
  codigoProducto  String?  @unique
  descripcion     String?
  imagen          String?
  activo          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relación con materiales usados en cotizaciones
  materialesUsados MaterialCotizacion[]

  @@index([categoria])
  @@index([activo])
}